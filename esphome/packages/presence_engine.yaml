# Bed Presence Engine Package
# Configures the custom presence detection component

binary_sensor:
  - platform: bed_presence_engine
    name: "Bed Occupied"
    id: bed_occupied
    energy_sensor: ld2410_still_energy
    occupied_threshold: 50
    vacant_threshold: 30
    debounce_occupied: 2000ms
    debounce_vacant: 5000ms
    state_reason:
      name: "Presence State Reason"
      id: presence_state_reason

# Number inputs to allow threshold tuning from Home Assistant
number:
  - platform: template
    name: "Occupied Threshold"
    id: occupied_threshold_input
    min_value: 0
    max_value: 100
    step: 1
    initial_value: 50
    optimistic: true
    mode: slider
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            int vacant = id(vacant_threshold_input).state;
            engine->update_thresholds((int)x, vacant);

  - platform: template
    name: "Vacant Threshold"
    id: vacant_threshold_input
    min_value: 0
    max_value: 100
    step: 1
    initial_value: 30
    optimistic: true
    mode: slider
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            int occupied = id(occupied_threshold_input).state;
            engine->update_thresholds(occupied, (int)x);

  - platform: template
    name: "Debounce Occupied (ms)"
    id: debounce_occupied_input
    min_value: 0
    max_value: 10000
    step: 100
    initial_value: 2000
    optimistic: true
    mode: box
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            uint32_t vacant_ms = id(debounce_vacant_input).state;
            engine->update_debounce_timers((uint32_t)x, vacant_ms);

  - platform: template
    name: "Debounce Vacant (ms)"
    id: debounce_vacant_input
    min_value: 0
    max_value: 30000
    step: 100
    initial_value: 5000
    optimistic: true
    mode: box
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            uint32_t occupied_ms = id(debounce_occupied_input).state;
            engine->update_debounce_timers(occupied_ms, (uint32_t)x);
